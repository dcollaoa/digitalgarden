[Microsoft SQL](https://www.microsoft.com/en-us/sql-server/sql-server-2019) (`MSSQL`) es el sistema de gestión de bases de datos relacionales basado en SQL de Microsoft. A diferencia de MySQL, que discutimos en la sección anterior, MSSQL es de código cerrado y fue escrito inicialmente para ejecutarse en sistemas operativos Windows. Es popular entre los administradores de bases de datos y desarrolladores al construir aplicaciones que se ejecutan en el marco de trabajo .NET de Microsoft debido a su fuerte soporte nativo para .NET. Existen versiones de MSSQL que se ejecutan en Linux y MacOS, pero es más probable que encontremos instancias de MSSQL en objetivos que ejecutan Windows.

### MSSQL Clients

[SQL Server Management Studio](https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15) (`SSMS`) viene como una característica que se puede instalar con el paquete de instalación de MSSQL o se puede descargar e instalar por separado. Comúnmente se instala en el servidor para la configuración inicial y la gestión a largo plazo de las bases de datos por parte de los administradores. Ten en cuenta que, dado que SSMS es una aplicación del lado del cliente, se puede instalar y usar en cualquier sistema desde el cual un administrador o desarrollador planee gestionar la base de datos. No solo existe en el servidor que aloja la base de datos. Esto significa que podríamos encontrarnos con un sistema vulnerable con SSMS con credenciales guardadas que nos permitan conectarnos a la base de datos. La imagen a continuación muestra SSMS en acción.

![SSMS](https://academy.hackthebox.com/storage/modules/112/ssms.png)

Muchos otros clientes pueden usarse para acceder a una base de datos que se ejecuta en MSSQL. Incluyendo, pero no limitado a:

- [mssql-cli](https://docs.microsoft.com/en-us/sql/tools/mssql-cli?view=sql-server-ver15)
- [SQL Server PowerShell](https://docs.microsoft.com/en-us/sql/powershell/sql-server-powershell?view=sql-server-ver15)
- [HeidiSQL](https://www.heidisql.com/)
- [SQLPro](https://www.macsqlclient.com/)
- [Impacket's mssqlclient.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/mssqlclient.py)

De los clientes MSSQL enumerados anteriormente, los pentesters pueden encontrar que mssqlclient.py de Impacket es el más útil debido a que el proyecto Impacket de SecureAuthCorp está presente en muchas distribuciones de pentesting al instalarse. Para encontrar si el cliente está instalado y dónde se encuentra en nuestro host, podemos usar el siguiente comando:

```r
locate mssqlclient

/usr/bin/impacket-mssqlclient
/usr/share/doc/python3-impacket/examples/mssqlclient.py
```

### MSSQL Databases

MSSQL tiene bases de datos del sistema predeterminadas que pueden ayudarnos a comprender la estructura de todas las bases de datos que pueden estar alojadas en un servidor objetivo. Estas son las bases de datos predeterminadas y una breve descripción de cada una:

| Base de Datos del Sistema Predeterminada | Descripción                                                                                                                                                                                            |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `master`                | Realiza un seguimiento de toda la información del sistema para una instancia de servidor SQL                                                                                                                                               |
| `model`                 | Base de datos de plantilla que actúa como estructura para cada nueva base de datos creada. Cualquier configuración cambiada en la base de datos model se reflejará en cualquier nueva base de datos creada después de los cambios en la base de datos model |
| `msdb`                  | El SQL Server Agent utiliza esta base de datos para programar trabajos y alertas                                                                                                                                      |
| `tempdb`                | Almacena objetos temporales                                                                                                                                                                               |
| `resource`              | Base de datos de solo lectura que contiene objetos del sistema incluidos con el servidor SQL                                                                                                                                  |

Fuente de la tabla: [System Databases Microsoft Doc](https://docs.microsoft.com/en-us/sql/relational-databases/databases/system-databases?view=sql-server-ver15)

---
## Default Configuration

Cuando un administrador instala y configura MSSQL para que sea accesible en la red, el servicio SQL probablemente se ejecutará como `NT SERVICE\MSSQLSERVER`. La conexión desde el lado del cliente es posible a través de la Autenticación de Windows, y de forma predeterminada, no se aplica cifrado al intentar conectarse.

![SSMS](https://academy.hackthebox.com/storage/modules/112/auth.png)

Tener la autenticación configurada en `Autenticación de Windows` significa que el sistema operativo Windows subyacente procesará la solicitud de inicio de sesión y usará la base de datos SAM local o el controlador de dominio (que aloja Active Directory) antes de permitir la conectividad con el sistema de gestión de bases de datos. Usar Active Directory puede ser ideal para auditar la actividad y controlar el acceso en un entorno Windows, pero si una cuenta se ve comprometida, podría llevar a una escalada de privilegios y movimiento lateral a través de un entorno de dominio Windows. Como con cualquier sistema operativo, servicio, función del servidor o aplicación, puede ser beneficioso configurarlo en una máquina virtual desde la instalación hasta la configuración para comprender todas las configuraciones predeterminadas y los posibles errores que el administrador podría cometer.

---
## Dangerous Settings

Puede ser beneficioso ponernos en la perspectiva de un administrador de TI cuando estamos en una tarea. Esta mentalidad puede ayudarnos a recordar buscar varias configuraciones que pueden haber sido configuradas de manera incorrecta o peligrosa por un administrador. Un día de trabajo en TI puede ser bastante ocupado, con muchos proyectos diferentes sucediendo simultáneamente y la presión para realizar tareas con rapidez y precisión siendo una realidad en muchas organizaciones, los errores se pueden cometer fácilmente. Solo se necesita una pequeña configuración incorrecta que podría comprometer un servidor o servicio crítico en la red. Esto se aplica a casi todos los servicios de red y funciones de servidor que se pueden configurar, incluido MSSQL.

Esta no es una lista extensa porque hay innumerables formas en que los administradores pueden configurar las bases de datos MSSQL según las necesidades de sus respectivas organizaciones. Podemos beneficiarnos al buscar las siguientes:

- Clientes MSSQL que no usan cifrado para conectarse al servidor MSSQL
    
- El uso de certificados autofirmados cuando se utiliza cifrado. Es posible suplantar certificados autofirmados
    
- El uso de [named pipes](https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15)
    
- Credenciales débiles y predeterminadas para `sa`. Los administradores pueden olvidar deshabilitar esta cuenta

---
## Footprinting the Service

Hay muchas formas en que podemos abordar el reconocimiento del servicio MSSQL, cuanto más específicos podamos ser con nuestros escaneos, más información útil podremos recopilar. NMAP tiene scripts predeterminados de MSSQL que se pueden usar para dirigirse al puerto tcp `1433` que MSSQL escucha de manera predeterminada.

El escaneo de scripts de NMAP a continuación nos proporciona información útil. Podemos ver el `hostname`, el `nombre de la instancia de base de datos`, la `versión de software de MSSQL` y que `named pipes están habilitados`. Nos beneficiaremos al agregar estos descubrimientos a nuestras notas.

### NMAP MSSQL Script Scan

```r
sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 10.129.201.248

Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-08 09:40 EST
Nmap scan report for 10.129.201.248
Host is up (0.15s latency).

PORT     STATE SERVICE  VERSION
1433/tcp open  ms-sql-s Microsoft SQL Server 2019 15.00.2000.00; RTM
| ms-sql-ntlm-info: 
|   Target_Name: SQL-01
|   NetBIOS_Domain_Name: SQL-01
|   NetBIOS_Computer_Name: SQL-01
|   DNS_Domain_Name: SQL-01
|   DNS_Computer_Name: SQL-01
|_  Product_Version: 10.0.17763

Host script results:
| ms-sql-dac: 
|_  Instance: MSSQLSERVER; DAC port: 1434 (connection failed)
| ms-sql-info: 
|   Windows server name: SQL-01
|   10.129.201.248\MSSQLSERVER: 
|     Instance name: MSSQLSERVER
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: false
|     TCP port: 1433
|     Named pipe: \\10.129.201.248\pipe\sql\query
|_    Clustered: false

Service detection performed. Please report any incorrect results at

 https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.52 seconds
```

También podemos usar Metasploit para ejecutar un escáner auxiliar llamado `mssql_ping` que escaneará el servicio MSSQL y proporcionará información útil en nuestro proceso de reconocimiento.

### MSSQL Ping in Metasploit

```r
msf6 auxiliary(scanner/mssql/mssql_ping) > set rhosts 10.129.201.248

rhosts => 10.129.201.248


msf6 auxiliary(scanner/mssql/mssql_ping) > run

[*] 10.129.201.248:       - SQL Server information for 10.129.201.248:
[+] 10.129.201.248:       -    ServerName      = SQL-01
[+] 10.129.201.248:       -    InstanceName    = MSSQLSERVER
[+] 10.129.201.248:       -    IsClustered     = No
[+] 10.129.201.248:       -    Version         = 15.0.2000.5
[+] 10.129.201.248:       -    tcp             = 1433
[+] 10.129.201.248:       -    np              = \\SQL-01\pipe\sql\query
[*] 10.129.201.248:       - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

### Connecting with Mssqlclient.py

Si podemos adivinar o acceder a credenciales, esto nos permite conectarnos remotamente al servidor MSSQL y comenzar a interactuar con bases de datos usando T-SQL (`Transact-SQL`). Autenticarnos con MSSQL nos permite interactuar directamente con bases de datos a través del motor de base de datos SQL. Desde Pwnbox o un host de ataque personal, podemos usar mssqlclient.py de Impacket para conectarnos como se ve en la salida a continuación. Una vez conectados al servidor, puede ser bueno conocer el entorno y listar las bases de datos presentes en el sistema.

```r
python3 mssqlclient.py Administrator@10.129.201.248 -windows-auth

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(SQL-01): Line 1: Changed database context to 'master'.
[*] INFO(SQL-01): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) 
[!] Press help for extra shell commands

SQL> select name from sys.databases

name                                                                                                                               

--------------------------------------------------------------------------------------

master                                                                                                                             

tempdb                                                                                                                             

model                                                                                                                              

msdb                                                                                                                               

Transactions    
```
```