Active Directory (AD) es un servicio de directorio para entornos de red Windows. Es una estructura distribuida y jerárquica que permite la gestión centralizada de los recursos de una organización, incluyendo usuarios, computadoras, grupos, dispositivos de red, archivos compartidos, políticas de grupo, dispositivos y trusts. AD proporciona funciones de autenticación y autorización dentro de un entorno de dominio Windows. Ha sido objeto de crecientes ataques en los últimos años. Está diseñado para ser retrocompatible, y muchas de sus características no son "seguras por defecto" y pueden ser fácilmente mal configuradas. Esta debilidad puede ser aprovechada para moverse lateral y verticalmente dentro de una red y obtener acceso no autorizado. AD es esencialmente una gran base de datos de solo lectura accesible para todos los usuarios dentro del dominio, independientemente de su nivel de privilegio. Una cuenta de usuario básica de AD sin privilegios adicionales puede enumerar la mayoría de los objetos dentro de AD. Este hecho hace que sea extremadamente importante asegurar adecuadamente una implementación de AD, ya que cualquier cuenta de usuario, independientemente de su nivel de privilegio, puede ser utilizada para enumerar el dominio y buscar minuciosamente fallos y configuraciones erróneas. Además, se pueden realizar múltiples ataques con solo una cuenta de usuario estándar del dominio, lo que muestra la importancia de una estrategia de defensa en profundidad y una planificación cuidadosa enfocada en la seguridad y el endurecimiento de AD, la segmentación de la red y el principio de mínimo privilegio. Un ejemplo es el ataque [noPac](https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware), que se dio a conocer por primera vez en diciembre de 2021.

Active Directory facilita a los administradores y usuarios encontrar y utilizar la información. AD es altamente escalable, admite millones de objetos por dominio y permite la creación de dominios adicionales a medida que una organización crece.

![image](https://academy.hackthebox.com/storage/modules/74/whyad5.png) [Source](https://dbaontap.com/2016/11/25/oem13c-roles-ad-groups/active-directory/)

Se estima que alrededor del 95% de las empresas [Fortune 500](https://en.wikipedia.org/wiki/Fortune_500) ejecutan Active Directory, lo que convierte a AD en un objetivo clave para los atacantes. Un ataque exitoso, como un phishing que permita a un atacante ingresar al entorno de AD como un usuario estándar del dominio, le daría suficiente acceso para comenzar a mapear el dominio y buscar vías de ataque. Como profesionales de la seguridad, encontraremos entornos AD de todos los tamaños a lo largo de nuestras carreras. Es esencial comprender la estructura y función de AD para estar mejor informados tanto como atacantes como defensores.

Los operadores de ransomware han estado apuntando cada vez más a Active Directory como una parte clave de sus rutas de ataque. El [Conti Ransomware](https://www.cisa.gov/sites/default/files/publications/AA21-265A-Conti_Ransomware_TLP_WHITE.pdf), que ha sido utilizado en más de 400 ataques en todo el mundo, ha demostrado aprovechar vulnerabilidades críticas recientes de Active Directory como [PrintNightmare (CVE-2021-34527)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527) y [Zerologon (CVE-2020-1472)](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472) para escalar privilegios y moverse lateralmente en una red objetivo. Comprender la estructura y función de Active Directory es el primer paso en un camino de carrera para encontrar y prevenir este tipo de fallos antes que los atacantes. Los investigadores están encontrando continuamente nuevos ataques de muy alto riesgo que afectan a los entornos de Active Directory y que a menudo requieren no más que una cuenta de usuario estándar del dominio para obtener control administrativo completo sobre todo el dominio. Existen muchas herramientas de código abierto excelentes para pentesters para enumerar y atacar Active Directory, pero para utilizarlas de manera más efectiva, debemos entender cómo funciona Active Directory para identificar fallos obvios y sutiles. Las herramientas son tan efectivas como lo sea el conocimiento del operador. Así que tomémonos el tiempo para entender la estructura y función de Active Directory antes de pasar a módulos posteriores que se enfocarán en la enumeración en profundidad, ataques, movimientos laterales, post-explotación y persistencia, tanto de manera manual como basada en herramientas.

Este módulo sentará las bases para comenzar en el camino de enumerar y atacar Active Directory. Cubriremos en profundidad la estructura y función de AD, discutiremos los diversos objetos de AD, los derechos y privilegios de los usuarios, herramientas y procesos para gestionar AD, e incluso realizaremos ejemplos de configuración de un pequeño entorno de AD.

---

## History of Active Directory

LDAP, la base de Active Directory, se introdujo por primera vez en [RFCs](https://en.wikipedia.org/wiki/Request_for_Comments) ya en 1971. Active Directory fue precedido por el concepto de unidad organizativa [X.500](https://en.wikipedia.org/wiki/X.500), que fue la primera versión de todos los sistemas de directorio creados por Novell y Lotus, y lanzado en 1993 como [Novell Directory Services](https://en.wikipedia.org/wiki/NetIQ_eDirectory).

Active Directory se introdujo por primera vez a mediados de los 90, pero no se convirtió en parte del sistema operativo Windows hasta el lanzamiento de Windows Server 2000. Microsoft intentó por primera vez proporcionar servicios de directorio en 1990 con el lanzamiento de Windows NT 3.0. Este sistema operativo combinó características del protocolo [LAN Manager](https://en.wikipedia.org/wiki/LAN_Manager) y los sistemas operativos [OS/2](https://en.wikipedia.org/wiki/OS/2), que Microsoft creó inicialmente junto con IBM, liderado por [Ed Iacobucci](https://en.wikipedia.org/wiki/Ed_Iacobucci), quien también dirigió el diseño de [IBM DOS](https://en.wikipedia.org/wiki/IBM_PC_DOS) y luego cofundó Citrix Systems. El sistema operativo NT evolucionó a lo largo de los 90, adaptando protocolos como LDAP y Kerberos con elementos propietarios de Microsoft. La primera versión beta de Active Directory fue en 1997.

El lanzamiento de Windows Server 2003 vio una funcionalidad extendida y una administración mejorada, y agregó la característica de `Forest`, que permite a los sysadmins crear "contenedores" de dominios, usuarios, computadoras y otros objetos separados bajo el mismo paraguas. [Active Directory Federation Services (ADFS)](https://en.wikipedia.org/wiki/Active_Directory_Federation_Services) se introdujo en Server 2008 para proporcionar Single Sign-On (SSO) a sistemas y aplicaciones para usuarios en sistemas operativos Windows Server. ADFS lo hizo más simple y más eficiente para que los usuarios inicien sesión en aplicaciones y sistemas que no están en la misma LAN.

ADFS permite a los usuarios acceder a aplicaciones a través de límites organizacionales utilizando un solo conjunto de credenciales. ADFS utiliza el modelo de Control de Acceso basado en [claims-based](https://en.wikipedia.org/wiki/Claims-based_identity), que intenta garantizar la seguridad en las aplicaciones al identificar a los usuarios por un conjunto de afirmaciones relacionadas con su identidad, las cuales se empaquetan en un token de seguridad por el proveedor de identidad.

El lanzamiento de Server 2016 trajo aún más cambios a Active Directory, como la capacidad de migrar entornos de AD a la nube y mejoras adicionales de seguridad, como el monitoreo de acceso de usuarios y [Group Managed Service Accounts (gMSA)](https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/service-accounts-group-managed). gMSA ofrece una forma más segura de ejecutar tareas automatizadas específicas, aplicaciones y servicios, y a menudo es una mitigación recomendada contra el infame ataque de Kerberoasting.

2016 vio un empuje más significativo hacia la nube con el lanzamiento de Azure AD Connect, que se diseñó como un método de Single Sign-On para usuarios que se migraban al entorno de Microsoft Office 365.

Active Directory ha sufrido diversas configuraciones erróneas desde 2000 hasta la actualidad. Regularmente se descubren nuevas vulnerabilidades que afectan a Active Directory y otras tecnologías que interfieren con AD, como Microsoft Exchange. A medida que los investigadores de seguridad continúan descubriendo nuevas fallas, las organizaciones que ejecutan Active Directory deben mantenerse al tanto de las actualizaciones y la implementación de correcciones. Como pentesters, se nos asigna la tarea de encontrar estos fallos para nuestros clientes antes que los atacantes.

Por esta razón, debemos tener una base sólida en los fundamentos de Active Directory y comprender su estructura, función, los diversos protocolos que utiliza para operar, cómo se gestionan los derechos y privilegios de los usuarios, cómo los sysadmins administran AD y la multitud de vulnerabilidades y configuraciones erróneas que pueden estar presentes en un entorno AD. Gestionar AD no es tarea fácil. Un cambio/arreglo puede introducir problemas adicionales en otros lugares. Antes de comenzar a enumerar y luego atacar Active Directory, cubramos los conceptos fundamentales que nos acompañarán a lo largo de nuestras carreras en infosec.

Como se mencionó anteriormente, el 95% de las empresas Fortune 500 ejecutan Active Directory, y Microsoft tiene un monopolio casi completo en el espacio de servicios de directorio. Aunque muchas empresas están en transición hacia entornos en la nube e híbridos, el AD on-prem no desaparecerá para muchas compañías. Si estás realizando engagements de network penetration testing, puedes estar casi seguro de que encontrarás AD de alguna manera en casi todos ellos.

Este conocimiento fundamental nos convertirá en mejores atacantes y nos dará información sobre AD que será extremadamente útil al proporcionar consejos de remediación a nuestros clientes. Una comprensión profunda de AD hará que desentrañar las capas sea menos desalentador, y tendremos la misma confianza al abordar un entorno con 10,000 hosts que con uno de 20.